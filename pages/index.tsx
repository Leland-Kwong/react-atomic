import { useEffect } from 'react'
import type { NextPage } from 'next'
import Head from 'next/head'
import styles from '../styles/Home.module.css'
import {
  atomRef,
  useReadAtom,
  useSetAtom,
  AtomRoot,
  AtomDevTools
} from '../libs/atomic-state'

interface Hello {
  text: string
  foo: 'bar'
}

const helloRef = atomRef<Hello>({
  key: 'Hello',
  defaultState: { text: 'Hello world', foo: 'bar' }
})

type TimeElapsed = number

const timerRef = atomRef<TimeElapsed>({
  key: 'TimeElapsed',
  defaultState: 0
})

const tick = (time: TimeElapsed, incrementBy: number) =>
  time + incrementBy
const identity = <T,>(x: T) => x

const SubComponent = () => {
  const count = useReadAtom(timerRef, identity)
  const update = useSetAtom(timerRef)

  useEffect(() => {
    const timer = setTimeout(() => {
      update(tick, 1)
    }, 1000)

    return () => clearTimeout(timer)
  }, [update, count])

  return <div>Time Elapsed: {count}s</div>
}

const setText = (s: Hello, text: string) => ({
  ...s,
  text
})

const AtomAppDemo = () => {
  const text = useReadAtom(helloRef, (s) => s.text)
  const update = useSetAtom(helloRef)
  const showSubComponent = text.length > 0
  const count = useReadAtom(timerRef, identity)

  return (
    <div>
      <input
        type="text"
        value={text}
        onChange={(ev) => {
          update(setText, ev.target.value)
        }}
      />
      {showSubComponent && <SubComponent />}
      <div>Count: {count}</div>
    </div>
  )
}

const Home: NextPage = () => {
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <h1>React Atomic</h1>

        <AtomRoot>
          <AtomAppDemo />
          <AtomDevTools />
        </AtomRoot>
      </main>
    </div>
  )
}

export default Home
