import { useEffect } from 'react'
import type { NextPage } from 'next'
import Head from 'next/head'
import styles from '../styles/Home.module.css'
import {
  atom,
  useQuery,
  useMutation,
  useReset,
  AtomRoot
} from '../libs/atomic-state'

interface Hello {
  text: string
}

const helloRef = atom<Hello>({
  key: 'Hello',
  defaultState: { text: 'Hello world' }
})

type TimeElapsed = number

const timerRef = atom<TimeElapsed>({
  key: 'TimeElapsed',
  defaultState: 0
})

const tick = (time: TimeElapsed, incrementBy: number) =>
  time + incrementBy

const SubComponent = () => {
  const count = useQuery(timerRef, (s) => s)
  const mutate = useMutation(timerRef)
  const reset = useReset(timerRef)

  useEffect(() => {
    const timer = setTimeout(() => {
      mutate(tick, 1)
    }, 1000)

    return () => clearTimeout(timer)
  })
  useEffect(() => reset, [reset])

  return <div>Time Elapsed: {count}s</div>
}

const setText = (_: Hello, text: string) => ({ text })

const AtomicStateDemo = () => {
  const state = useQuery(helloRef, (s) => s)
  const mutate = useMutation(helloRef)

  return (
    <div>
      <input
        type="text"
        value={state.text}
        onChange={(ev) => {
          mutate(setText, ev.target.value)
        }}
      />
      {state.text.length > 0 && <SubComponent />}
    </div>
  )
}

const Home: NextPage = () => {
  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <h1>Atomic State</h1>

        <AtomRoot>
          <AtomicStateDemo />
        </AtomRoot>
      </main>
    </div>
  )
}

export default Home
